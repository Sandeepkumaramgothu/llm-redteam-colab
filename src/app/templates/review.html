<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Review & Label</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    .row { margin: 10px 0; }
    .box { border: 1px solid #ddd; padding: 12px; border-radius: 8px; background: #fafafa; margin: 12px 0; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; white-space: pre-wrap; }
    button { padding: 6px 10px; margin-right: 6px; }
    input, select, textarea { padding: 6px 8px; }
    textarea { width: 100%; min-height: 80px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eee; margin-right: 6px; }
    .muted { color: #666; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  </style>
</head>
<body>
  <p><a href="/">← Back to Home</a></p>
  <h2>Review & Label</h2>

  <div class="box row">
    <label>Start index: <input id="start" type="number" value="0" min="0" style="width: 100px"></label>
    <label>Batch size:
      <select id="limit">
        <option>1</option>
        <option selected>5</option>
        <option>10</option>
        <option>25</option>
      </select>
    </label>
    <button id="load">Load</button>
    <button id="recompute">Recompute metrics</button>
    <span id="msg" class="muted"></span>
  </div>

  <div id="items"></div>

<script>
  function toProxy(rel) {
    if (!rel) return window.location.href;
    if (rel.startsWith("/")) rel = rel.slice(1);
    return new URL(rel, window.location.href).href;
  }
  async function getJSON(path) {
    const r = await fetch(toProxy(path));
    const ct = r.headers.get("content-type") || "";
    const txt = await r.text();
    if (!ct.includes("application/json")) throw new Error(`HTTP ${r.status} ${ct} :: ${txt.slice(0,200)}`);
    const data = JSON.parse(txt);
    if (!r.ok || data.ok === false) throw new Error((data && data.error) || `HTTP ${r.status}`);
    return data;
  }
  async function postJSON(path, body) {
    const r = await fetch(toProxy(path), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body || {})
    });
    const ct = r.headers.get("content-type") || "";
    const txt = await r.text();
    if (!ct.includes("application/json")) throw new Error(`HTTP ${r.status} ${ct} :: ${txt.slice(0,200)}`);
    const data = JSON.parse(txt);
    if (!r.ok || data.ok === false) throw new Error((data && data.error) || `HTTP ${r.status}`);
    return data;
  }

  function renderCard(row) {
    const wrap = document.createElement("div");
    wrap.className = "box row";
    const idx = row.index;

    const h = document.createElement("div");
    h.innerHTML = `<span class="pill">#${idx}</span>` +
                  `<span class="pill">new toks: ${row.new_tokens ?? ""}</span>` +
                  `<span class="pill">gen time: ${row.gen_time_sec ?? ""} s</span>`;
    wrap.appendChild(h);

    const grid = document.createElement("div");
    grid.className = "grid";
    wrap.appendChild(grid);

    const left = document.createElement("div");
    left.innerHTML = `<h3>Prompt</h3><div class="mono">${(row.prompt||"").replaceAll("<","&lt;")}</div>`;
    grid.appendChild(left);

    const right = document.createElement("div");
    const auto = row.auto || {};
    const autoLine = (auto.auto_label ? `${auto.auto_label}` : "") +
                     (auto.hits && auto.hits.length ? ` — ${auto.hits.join(",")}` : "");
    right.innerHTML = `<h3>Output</h3><div class="mono">${(row.output||"").replaceAll("<","&lt;")}</div>` +
                      `<p class="muted">Auto: ${autoLine}</p>`;
    grid.appendChild(right);

    const lab = row.label || {};
    const current = document.createElement("div");
    current.className = "row";
    current.textContent = `Current: ${lab.label || "(none)"}${(lab.severity!=null? " (sev "+lab.severity+")":"")}${(lab.notes? " — "+lab.notes:"")}`;
    wrap.appendChild(current);

    const controls = document.createElement("div");
    controls.className = "row";
    controls.innerHTML = `
      <label>Label:
        <select id="label-${idx}">
          <option value="">(choose)</option>
          <option value="safe"${lab.label==='safe'?' selected':''}>safe (S)</option>
          <option value="violation"${lab.label==='violation'?' selected':''}>violation (V)</option>
        </select>
      </label>
      <label>Severity:
        <select id="sev-${idx}">
          <option value="">(none)</option>
          <option value="0"${lab.severity===0?' selected':''}>0</option>
          <option value="1"${lab.severity===1?' selected':''}>1</option>
          <option value="2"${lab.severity===2?' selected':''}>2</option>
          <option value="3"${lab.severity===3?' selected':''}>3</option>
        </select>
      </label>
      <button id="save-${idx}">Save</button>
      <button id="prev-${idx}">Prev (P)</button>
      <button id="next-${idx}">Next (N)</button>
    `;
    wrap.appendChild(controls);

    const notes = document.createElement("div");
    notes.className = "row";
    notes.innerHTML = `<label>Notes:<br><textarea id="notes-${idx}" placeholder="why?">${lab.notes || ""}</textarea></label>`;
    wrap.appendChild(notes);

    controls.querySelector("#save-"+idx).onclick = async () => {
      await save(idx);
    };
    controls.querySelector("#prev-"+idx).onclick = () => move(-1);
    controls.querySelector("#next-"+idx).onclick = () => move(+1);

    wrap.addEventListener("keydown", async (ev) => {
      const k = ev.key.toLowerCase();
      if (k === "s") { document.getElementById("label-"+idx).value = "safe"; await save(idx); ev.preventDefault(); }
      if (k === "v") { document.getElementById("label-"+idx).value = "violation"; await save(idx); ev.preventDefault(); }
      if (["0","1","2","3"].includes(k)) { document.getElementById("sev-"+idx).value = k; ev.preventDefault(); }
      if (k === "n") { move(+1); ev.preventDefault(); }
      if (k === "p") { move(-1); ev.preventDefault(); }
    });

    return wrap;
  }

  async function save(idx) {
    const label = document.getElementById("label-"+idx).value || "";
    const sevRaw = document.getElementById("sev-"+idx).value;
    const severity = (sevRaw === "" ? None : parseInt(sevRaw, 10)); // JS 'null' spelled null; 'None' here is a string sentinel for backend.
    const notes = document.getElementById("notes-"+idx).value || null;
    try {
      // We pass run_id: null to mean "latest run" on the server.
      const out = await postJSON("/api/review_save", { run_id: null, index: idx, label, severity, notes });
      document.getElementById("msg").textContent = "Saved label for #"+idx;
    } catch (e) {
      document.getElementById("msg").textContent = "Save failed: " + e.message;
    }
  }

  function move(delta) {
    const startEl = document.getElementById("start");
    const limitEl = document.getElementById("limit");
    const start = Math.max(0, parseInt(startEl.value || "0", 10) + (delta * parseInt(limitEl.value || "1", 10)));
    startEl.value = String(start);
    document.getElementById("load").click();
  }

  async function loadBatch() {
    const start = parseInt(document.getElementById("start").value || "0", 10);
    const limit = parseInt(document.getElementById("limit").value || "5", 10);
    try {
      document.getElementById("msg").textContent = "loading...";
      const d = await getJSON(`/api/review_data?start=${start}&limit=${limit}`);
      const items = d.items || [];
      const cont = document.getElementById("items");
      cont.innerHTML = "";
      items.forEach((row) => {
        const card = renderCard(row);
        cont.appendChild(card);
        card.tabIndex = 0;
        card.focus({preventScroll:true});
      });
      document.getElementById("msg").textContent = `showing ${items.length} item(s); total=${d.total}`;
    } catch (e) {
      document.getElementById("msg").textContent = "load failed: " + e.message;
    }
  }

  async function recompute() {
    try {
      const out = await postJSON("/api/recompute_metrics", { run_id: null });
      document.getElementById("msg").textContent = "Manual metrics updated";
    } catch (e) {
      document.getElementById("msg").textContent = "Recompute failed: " + e.message;
    }
  }

  document.getElementById("load").onclick = loadBatch;
  document.getElementById("recompute").onclick = recompute;
  loadBatch();
</script>
</body>
</html>
